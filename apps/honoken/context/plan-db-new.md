# Honoken Wallet: DB Consolidation & Orchestration Plan (Final, Consolidated)

This document is the single source of truth for the wallet database consolidation, write-time ETag strategy, Inngest orchestration, and read-only GET paths in the Honoken service. It supersedes earlier drafts and reflects the code that exists today, along with clearly scoped remaining work.

---

## Executive Summary

- Shared monorepo database package (`packages/database`) now defines all wallet tables with Drizzle V2.
- Honoken reads and writes via the shared schema and a small repository layer responsible for ETag-on-write.
- GET paths are pure read-only and rely on stored `etag` and `updated_at`.
- An Inngest workflow (`wallet-pass-update`) orchestrates durable writes, then pushes APNs.
- A dev-only admin push endpoint exists to manually trigger pushes outside of content updates.

Remaining improvements (tracked in TODOs): enable per-pass concurrency and idempotency in Inngest; add guardrails to prevent raw writes outside the repo; expand tests; add brief README notes.

---

## Current State (as implemented)

- Schema is consolidated in `packages/database/schema/wallet.ts` using Drizzle V2 with surrogate IDs and unique constraints for natural keys.
- Honoken app imports `schema` and `db` from the shared database package.
- Repository layer (`apps/honoken/src/repo/wallet.ts`) performs all writes that impact the pkpass output and computes/stores ETags within the same transaction.
- ETag middleware (`apps/honoken/src/middleware/pkpass-etag.ts`) is read-only and sets `ETag`, `Last-Modified`, and `Cache-Control` headers.
- Inngest function (`packages/inngest/functions/wallet-pass-update.ts`) exists and is exported from the package index; it writes content → recomputes ETag → loads registrations → pushes via APNs.
- Admin route (`apps/honoken/src/routes/admin.ts`) includes cert rotation, explicit cert cache invalidation, and a dev-only push endpoint.

---

## Decisions (locked)

- Runtime: Node 22 across apps and on Vercel.
- Tokens: Keep plaintext tokens in `wallet_pass.authentication_token` per Apple spec; add btree index for fast lookup. Exclude token from ETag composition.
- Table naming: `wallet_*` prefix; snake_case columns.
- Pass content: Split to `wallet_pass_content.data` (JSONB) one-to-one per pass. Keep hot row (`wallet_pass`) narrow.
- ETag strategy: Compute on writes only; store `wallet_pass.etag`; GET never writes.
- Updated clock: Always bump `wallet_pass.updated_at` to seconds precision when material changes happen.
- Tenancy & timestamps: Use shared helpers `createdBy()` and `timeStamps({ softDelete: true })` consistently.
- Logs: PostHog only; no DB table for device logs.
- APNs: Production fan-out via Inngest steps; optional dev-only push endpoint.
- Assets: Vercel Blob adapter is used for pass assets; PNG verification retained.
- Migrations: Owned and generated by `packages/database`; apps do not generate local migrations.

---

## Data Model (Drizzle V2, as-built)

The shared schema uses surrogate IDs and unique constraints for natural keys. Highlights below (refer to `packages/database/schema/wallet.ts` for full definitions):

- `wallet_ticket_style_enum`: `('coupon','event','storeCard','generic')`.
- `wallet_cert`:
  - `id` (surrogate PK), unique `cert_ref`, `team_id`, `encrypted_bundle`, `is_enhanced`, timestamps (soft-delete).
  - Indexes: by `is_enhanced`, by `team_id`.
- `wallet_apns_key`:
  - `id` (PK), `key_ref`, `team_id`, `is_active`, `key_id`, `encrypted_p8_key`, timestamps.
  - Indexes: `(team_id,is_active)` and unique `(team_id,key_id)`, unique `key_ref`.
- `wallet_pass_type`:
  - `id` (PK), unique `pass_type_identifier`, `cert_ref` → `wallet_cert.cert_ref`, timestamps.
  - Index: by `cert_ref`.
- `wallet_pass` (hot row):
  - `id` (PK), unique `(pass_type_identifier, serial_number)` via `uq_wallet_pass_type_serial`.
  - `authentication_token`, `ticket_style` (enum), `poster` (bool), `etag` (text), timestamps, `createdBy()`.
  - Indexes: by `updated_at`, by `authentication_token`.
- `wallet_device`:
  - `id` (PK), unique `device_library_identifier`, `push_token`, timestamps.
- `wallet_registration`:
  - `id` (PK), `pass_id` → `wallet_pass.id` (cascade on update/delete),
  - `device_library_identifier` → `wallet_device.device_library_identifier`,
  - denormalized `pass_type_identifier`, `serial_number` for indexed lookups, `active` bool, timestamps, `createdBy()`.
  - Indexes: by `(pass_type_identifier, serial_number)`, by `(device_library_identifier, active)`, unique `(device_library_identifier, pass_id)`.
- `wallet_pass_content` (1:1 content):
  - `id` (PK), `pass_id` unique → `wallet_pass.id` (cascade), `data` JSONB, timestamps, `createdBy()`.

Notes:

- Choosing surrogate IDs simplifies FKs and write helpers while retaining unique natural keys for query performance.
- Denormalized `(pass_type_identifier, serial_number)` on `wallet_registration` preserves efficient “list-updated-serials” style queries.

---

## ETag-on-Write (Repository Layer)

All writes that can change the pkpass output go through small, transactional helpers in `apps/honoken/src/repo/wallet.ts`:

- `upsertPassContentWithEtag(db, { passTypeIdentifier, serialNumber }, data)`
  - Validates pass exists, loads existing content (by `pass_id`).
  - Stable-compares JSON (`stableStringify`) to detect material change.
  - Inserts/updates `wallet_pass_content` as needed.
  - Computes ETag from a minimal payload: `{ passTypeIdentifier, serialNumber, ticketStyle, poster, updatedAtSec, content }`.
  - Rounds `updatedAt` to seconds and updates `wallet_pass` with `{ etag, updatedAt }` in the same transaction.
  - Returns `{ etag, updatedAt, changed }` (changed=false when no material change; returns existing ETag if present).

- `updatePassMetadataWithEtag(db, key, patch)`
  - Updates metadata fields (e.g., `ticket_style`, `poster`).
  - Reloads pass and content, recomputes ETag using seconds-rounded `updatedAt`.
  - Updates `wallet_pass` with `{ etag, updatedAt }` in the same transaction.

Composition rules:

- Exclude `authentication_token` from ETag.
- Use a deterministic, stable JSON representation for payload hashing.
- Always bump `updated_at` to seconds granularity for conditional GET semantics.

---

## Read-Only GET Path

- Middleware: `apps/honoken/src/middleware/pkpass-etag.ts`
  - Loads minimal pass row.
  - Sets `ETag: "<etag>"`, `Last-Modified: <updatedAt (UTC)>`, and `Cache-Control: no-cache, no-store, must-revalidate`.
  - Honors `If-None-Match` (preferred) and `If-Modified-Since` (seconds precision) to return `304` early.
  - Never writes to the database.

- Pass builder: `apps/honoken/src/passkit/passkit.ts`
  - Reads `wallet_pass`, `wallet_pass_type` → `wallet_cert`, and `wallet_pass_content.data`.
  - Assembles `pass.json`, loads assets from Vercel Blob (with PNG validation), and signs with `passkit-generator`.
  - Does not compute or persist ETag.

---

## Inngest Orchestration (Write → Then Push)

- Event contract: `pass/update.requested` with `{ passTypeIdentifier, serialNumber, content }`.
- Function: `packages/inngest/functions/wallet-pass-update.ts` (exported from the package’s functions index)
  - Step 1 `write-etag`: call `upsertPassContentWithEtag`. If no material change, exit early.
  - Step 2 `load-registrations`: query active device registrations joined to devices to get push tokens.
  - Step 3 `apns-push`: fan-out APNs push via `pushToMany` with bounded concurrency (helper handles limits).

Recommended hardening (remaining work):

- Per-pass concurrency implemented (Sept 9, 2025) — serialize updates per pass.
- Add idempotency key for APNs step (e.g., `wallet:${pt}:${sn}:${etag}`) to avoid duplicate pushes for identical state.
- Ensure consistent logger injection and DB client factory usage.

---

## Admin & Operations

- `PUT /admin/certs/:certRef`: rotate PassKit signing certs (encrypted bundle). Immediately invalidates in-process cache.
- `POST /admin/invalidate/certs/:certRef`: force local cache invalidation.
- `POST /admin/push/:passTypeIdentifier/:serialNumber` (dev-only):
  - Loads active registrations and triggers `pushToMany` directly.
  - Disabled when `ENVIRONMENT === 'production'`.

---

## Guardrails

- Prefer a linter rule to prevent raw writes to `walletPass`/`walletPassContent` outside `apps/honoken/src/repo/**`.
- If using ESLint in this app, `no-restricted-imports` can block importing the writeable schema in non-repo modules.
- With Biome/Ultracite, enforce project conventions and add code reviews to ensure repo-only writes.

Example ESLint override (if applicable):

```jsonc
{
  "overrides": [
    {
      "files": ["apps/honoken/src/**/*.ts"],
      "rules": {
        "no-restricted-imports": [
          "error",
          {
            "paths": [
              {
                "name": "database/schema",
                "importNames": ["walletPass", "walletPassContent"],
                "message": "Do not write walletPass/walletPassContent directly; use apps/honoken/src/repo/wallet.ts",
              },
            ],
          },
        ],
      },
    },
    {
      "files": ["apps/honoken/src/repo/**/*.ts"],
      "rules": { "no-restricted-imports": "off" },
    },
  ],
}
```

---

## Testing Strategy

- Unit
  - ETag composition with field combinations (ticketStyle, poster) and seconds rounding.
  - JSONB upsert behavior (insert vs update) and `changed` detection.
- Integration
  - End-to-end Inngest flow: emit event → write & ETag → registrations load → APNs step invoked.
  - Admin dev push: auth success/failure, prod disablement, no registrations path.
- Smoke
  - Conditional GET: initial 200 with headers; 304 on `If-None-Match`; 304 on `If-Modified-Since` (seconds precision); 200 after content update.
- Load
  - High cardinality registrations and bounded APNs concurrency (ensure sockets stable and step idempotency respected).

---

## Operational Notes

- Environment variables
  - `DATABASE_URL` (prod), `DEV_DATABASE_URL` (dev migrations in shared package)
  - APNs keys, cert bundle storage encryption keys
  - `HONOKEN_IMAGES_READ_WRITE_TOKEN` for Vercel Blob assets
  - Admin basic auth: `HONOKEN_ADMIN_USERNAME`, `HONOKEN_ADMIN_PASSWORD`
  - Analytics: `POSTHOG_PROJECT_API_KEY`, optional `POSTHOG_HOST`
- Node & Vercel
  - Node 22 runtime; align `package.json` engines and `vercel.json` where applicable.
- Migrations
  - Generate only from `packages/database` (Drizzle Kit). Apply via Neon.

---

## Rollout Steps

1. Confirm shared schema is applied to Neon (greenfield create) and matches `packages/database/schema/wallet.ts`.
2. Keep Honoken wired to the shared `database` package (no local schema).
3. Harden Inngest function with per-pass concurrency & APNs step idempotency.
4. Add guardrail to prevent raw writes outside repo layer (linter or code review policy).
5. Complete unit/integration/smoke tests; verify conditional GETs; verify dev push.
6. Update README with a concise section on the Inngest workflow and dev push.

---

## Risk & Rollback

- Because this is a greenfield schema, rollback risk is limited to application-level behavior.
- If issues arise:
  - Disable Inngest triggers temporarily; serve GET using stored ETags (read-only path remains safe).
  - Re-enable after fixes; no data migrations are necessary for ETag logic.

---

## Appendix: ETag Composition (reference)

- Fields included: `passTypeIdentifier`, `serialNumber`, `ticketStyle`, `poster`, `updatedAtSec`, and `wallet_pass_content.data`.
- Fields excluded: `authentication_token`.
- Hashing: SHA‑256 over a stable stringified JSON payload; stored lowercase hex; always quote in the `ETag` header.

---

## Progress Log

- 2025-09-09: Implemented per-pass concurrency in Inngest `wallet-pass-update` to serialize updates by pass; updated README with a short note; lint clean. Next: consider adding explicit APNs step idempotency key and import path cleanup.
- 2025-09-09: Unified DB client factory usage in Inngest by adapting logger and passing it to `getDbClient`; reused the same adapter for APNs pushes.
- 2025-09-09: Added unit tests for ETag helpers covering stable order, content change, seconds rounding (same-second unchanged), and poster flag changes.
